# Perparation
library(tidyverse)
library(openxlsx)
library(purrr)
library(httr)
library(jsonlite)
library(openai)
Sys.setenv(OPENAI_API_KEY = "x")
####################################################################
## Initial processing of the ILO data
####################################################################
structure <- read.xlsx("Input//ISCO-08 EN Structure and definitions.xlsx") %>%
janitor::clean_names ()
definition_l1 <- structure %>%
# filter only level-2 for taxonomies
filter (level == "1") %>%
mutate(
tasks_include = str_remove(tasks_include, paste0("Tasks performed by ", str_to_lower(title_en)," usually include: \\s*")),
task_list = str_split(tasks_include, ";\\s*")
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_trim(task_list),
task = str_remove(task, "\\.$"),  # Remove final period
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition_l2 <- structure %>%
# filter only level-2 for taxonomies
filter (level == "2") %>%
select (isco_08_code, tasks_include) %>%
mutate(
tasks_include = str_remove(tasks_include, "Tasks performed by workers in this sub-major group usually include: \\s*"),
task_list = str_split(tasks_include, ";\\s*")
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_trim(task_list),
task = str_remove(task, "\\.$"),  # Remove final period
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition_l3 <- structure %>%
# filter only level-3 for taxonomies
filter (level == "3") %>%
select (isco_08_code, tasks_include) %>%
mutate(
tasks_include = str_remove(tasks_include, "Tasks performed usually include:\\s*"),
task_list = str_split(tasks_include, ";\\s*")
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_trim(task_list),
task = str_remove(task, "\\.$"),  # Remove final period
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition_l4 <- structure %>%
# filter only level-4 for taxonomies
filter (level == "4") %>%
select (isco_08_code, tasks_include) %>%
mutate(
tasks_include = str_remove(tasks_include, "Tasks include -\\s*"),  # Remove lead-in
task_list = str_extract_all(tasks_include, "\\(\\w\\)\\s[^\\(\\)]+(?:;|\\.)")  # Extract bullet points
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_remove(task_list, "^\\(\\w\\)\\s*"),  # Remove (a), (b), etc.
task = str_trim(task),
task = str_remove(task, ";$|\\.$"),  # Remove trailing punctuation
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition <- definition_l1 %>%
rbind (definition_l2) %>%
rbind (definition_l3) %>%
rbind (definition_l4) %>%
arrange (isco_08_code) %>% drop_na (task)
remove (definition_l1)
remove (definition_l2)
remove (definition_l3)
remove (definition_l4)
write.xlsx (definition, "content//ISCO task list.xlsx")
View(definition)
# Perparation
library(tidyverse)
library(openxlsx)
library(purrr)
library(httr)
library(jsonlite)
library(openai)
Sys.setenv(OPENAI_API_KEY = "x")
####################################################################
## Initial processing of the ILO data
####################################################################
structure <- read.xlsx("Input//ISCO-08 EN Structure and definitions.xlsx") %>%
janitor::clean_names ()
definition_l1 <- structure %>%
# filter only level-2 for taxonomies
filter (level == "1") %>%
mutate(
tasks_include = str_remove(tasks_include, paste0("Tasks performed by ", str_to_lower(title_en)," usually include: \\s*")),
task_list = str_split(tasks_include, ";\\s*")
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_trim(task_list),
task = str_remove(task, "\\.$"),  # Remove final period
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition_l2 <- structure %>%
# filter only level-2 for taxonomies
filter (level == "2") %>%
select (isco_08_code, tasks_include) %>%
mutate(
tasks_include = str_remove(tasks_include, "Tasks performed by workers in this sub-major group usually include: \\s*"),
task_list = str_split(tasks_include, ";\\s*")
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_trim(task_list),
task = str_remove(task, "\\.$"),  # Remove final period
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition_l3 <- structure %>%
# filter only level-3 for taxonomies
filter (level == "3") %>%
select (isco_08_code, tasks_include) %>%
mutate(
tasks_include = str_remove(tasks_include, "Tasks performed usually include:\\s*"),
task_list = str_split(tasks_include, ";\\s*")
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_trim(task_list),
task = str_remove(task, "\\.$"),  # Remove final period
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
definition_l4 <- structure %>%
# filter only level-4 for taxonomies
filter (level == "4") %>%
select (isco_08_code, tasks_include) %>%
mutate(
tasks_include = str_remove(tasks_include, "Tasks include -\\s*"),  # Remove lead-in
task_list = str_extract_all(tasks_include, "\\(\\w\\)\\s[^\\(\\)]+(?:;|\\.)")  # Extract bullet points
) %>%
select(isco_08_code, task_list) %>%
unnest(task_list) %>%
mutate(
task = str_remove(task_list, "^\\(\\w\\)\\s*"),  # Remove (a), (b), etc.
task = str_trim(task),
task = str_remove(task, ";$|\\.$"),  # Remove trailing punctuation
task = str_to_sentence(task)
) %>%
select(isco_08_code, task)
task_for_clustering <- definition %>%
distinct (task)
View(task_for_clustering)
write.xlsx (task_for_clustering, "content//ISCO task list.xlsx")
write.xlsx (definition, "content//ISCO task list.xlsx", overwrite = T)
